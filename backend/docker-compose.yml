services:
  # ============ Reverse Proxy (Traefik) ============
  traefik:
    image: traefik:v2.10
    container_name: nerdie-traefik
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

      # ACME / Let's Encrypt with webroot
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=support@nerdie.lol"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Traefik dashboard

    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"
      - "./certbot/www:/var/www/certbot"
      - "./certbot/conf:/etc/letsencrypt:ro"

    restart: unless-stopped
    networks:
      - nerdie-network

  # ============ Auth Service ============
  auth:
    build:
      context: ./auth
      dockerfile: Dockerfile
    container_name: nerdie-auth
    env_file:
      - ./auth/.env
    restart: unless-stopped
    networks:
      - nerdie-network

    labels:
      - "traefik.enable=true"
      # HTTP Router
      - "traefik.http.routers.auth.rule=Host(`auth.nerdie.lol`)"
      - "traefik.http.routers.auth.entrypoints=websecure"
      - "traefik.http.routers.auth.tls=true"
      - "traefik.http.routers.auth.tls.certresolver=letsencrypt"
      - "traefik.http.services.auth.loadbalancer.server.port=8000"
      # CORS headers
      - "traefik.http.middlewares.auth-cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE"
      - "traefik.http.middlewares.auth-cors.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.auth-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.routers.auth.middlewares=auth-cors"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/auth/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============ RAG Service ============
  rag:
    build:
      context: ./rag_service
      dockerfile: Dockerfile
    container_name: nerdie-rag
    env_file:
      - ./rag_service/.env
    restart: unless-stopped
    networks:
      - nerdie-network

    depends_on:
      postgres:
        condition: service_healthy

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rag.rule=Host(`rag.nerdie.lol`)"
      - "traefik.http.routers.rag.entrypoints=websecure"
      - "traefik.http.routers.rag.tls=true"
      - "traefik.http.routers.rag.tls.certresolver=letsencrypt"
      - "traefik.http.services.rag.loadbalancer.server.port=8001"
      # CORS headers
      - "traefik.http.middlewares.rag-cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE"
      - "traefik.http.middlewares.rag-cors.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.rag-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.routers.rag.middlewares=rag-cors"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ============ Ingestion Service ============
  ingestion:
    build:
      context: ./ingestion
      dockerfile: Dockerfile
    container_name: nerdie-ingestion
    env_file:
      - ./ingestion/.env
    volumes:
      - ./auth/firebase-credentials.json:/app/firebase-credentials.json:ro
    restart: unless-stopped
    networks:
      - nerdie-network

    depends_on:
      - postgres

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ingest.rule=Host(`ingest.nerdie.lol`)"
      - "traefik.http.routers.ingest.entrypoints=websecure"
      - "traefik.http.routers.ingest.tls=true"
      - "traefik.http.routers.ingest.tls.certresolver=letsencrypt"
      - "traefik.http.services.ingest.loadbalancer.server.port=8002"
      # CORS headers
      - "traefik.http.middlewares.ingest-cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE"
      - "traefik.http.middlewares.ingest-cors.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.ingest-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.routers.ingest.middlewares=ingest-cors"

  # ============ PostgreSQL with pgvector ============
  postgres:
    image: pgvector/pgvector:pg15
    container_name: nerdie-postgres
    environment:
      POSTGRES_USER: nerdie
      POSTGRES_PASSWORD: nerdie_password
      POSTGRES_DB: nerdie_rag
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - nerdie-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nerdie -d nerdie_rag"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  nerdie-network:
    driver: bridge

volumes:
  postgres_data:
